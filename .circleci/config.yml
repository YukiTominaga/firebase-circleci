version: 2.1
jobs:
  get-token:
    working_directory: ~/workdir
    docker:
      - image: google/cloud-sdk:alpine
    steps:
      - checkout
      - run:
          name: create service account key file
          command: echo ${GOOGLE_SERVICE_KEY} > key.json
          working_directory: ~/workdir
      - run:
          name: activate service account
          command: gcloud auth activate-service-account tokencreator@ca-tominaga.iam.gserviceaccount.com  --key-file=key.json
          working_directory: ~/workdir
      - run:
          name: export token as environment variables
          command: gcloud auth print-access-token --impersonate-service-account=firebase-adminsdk-tjdki@ca-tominaga.iam.gserviceaccount.com > access-token.txt
          working_directory: ~/workdir
      - persist_to_workspace:
          root: /root/workdir
          paths:
            - access-token
  firebase-deploy:
    working_directory: ~/workdir
    docker:
      - image: node:16-alpine
    steps:
      - attach_workspace:
          at: ~/workdir
      - checkout
      - run:
          name: print token
          command: export TOKEN=`cat access-token.txt` && echo $TOKEN
          working_directory: ~/workdir
      - run:
          name: yarn install
          command: yarn install
          working_directory: ~/workdir
      - run:
          name: firebase deploy with token
          command: firebase --token `cat access-token.txt` deploy
          working_directory: ~/workdir

workflows:
  version: 2
  deploy:
    jobs:
      - get-token
      - firebase-deploy:
          requires:
            - get-token
